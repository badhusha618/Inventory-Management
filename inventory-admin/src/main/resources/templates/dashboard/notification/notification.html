<!DOCTYPE html>
<!--/*
  ~
  ~    Copyright (c) 2017 Makinus Pvt Ltd - All Rights Reserved
  ~
  ~    Unauthorized copying of this file, via any medium is strictly prohibited
  ~    Proprietary and confidential
  ~    Written by Makinus Pvt Ltd
  ~
  */-->
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{dashboard/dashboard-layout}"
      th:with="notificationModule='active',notificationPageModule='active' "
      xmlns:display="http://www.w3.org/1999/xhtml">

<head>
    <title>Notification</title>
    <!-- GLOBAL MAINLY STYLES-->
    <link href="/resources/css/bootstrap.min.css" th:href="@{/resources/css/bootstrap.min.css}" rel="stylesheet"
          media="screen"/>
    <link href="/resources/css/font-awesome.min.css" th:href="@{/resources/css/font-awesome.min.css}" rel="stylesheet"
          media="screen"/>
    <link href="/resources/css/themify-icons.css" th:href="@{/resources/css/themify-icons.css}" rel="stylesheet"
          media="screen"/>
    <link href="/resources/css/sweetalert2.min.css" th:href="@{/resources/css/sweetalert2.min.css}" rel="stylesheet"
          media="screen"/>
    <!-- THEME STYLES-->
    <link href="/resources/css/main.css" th:href="@{/resources/css/main.css}" rel="stylesheet"/>
    <link href="/resources/css/bootstrap-datepicker3.min.css" th:href="@{/resources/css/bootstrap-datepicker3.min.css}"
          rel="stylesheet" media="screen"/>
    <!-- PAGE LEVEL STYLES-->
</head>

<body>

<th:block layout:fragment="header">
    <div th:replace="~{dashboard/header :: header}"></div>
</th:block>

<th:block layout:fragment="sidebar">
    <div th:replace="~{dashboard/sidebar :: sidebar}"></div>
</th:block>

<th:block layout:fragment="content">
    <!-- START PAGE CONTENT-->
    <div class="page-heading">
        <h1 class="page-title">Notification</h1>
    </div>

    <div class="page-content fade-in-up">
        <div class="row">
            <div class="col-md-12">
                <div class="ibox">
                    <div class="ibox-head">
                        <div class="ibox-title">Send Notification</div>
                        <div class="ibox-tools">
                            <a class="ibox-collapse"><i class="fa fa-minus"></i></a>
                        </div>
                    </div>
                    <div class="ibox-body">
                        <form id="notificationForm" action="/notification.mk" th:action="@{/notification.mk}"
                              th:object="${notificationForm}" method="post" enctype="multipart/form-data">

                            <div class="row">
                                <div class="col-sm-3 form-group">
                                    <label>Order No <span class="text-danger">*</span></label>
                                    <select class="form-control" id="orderNo" th:field="*{orderNo}">
                                        <option value="">Select</option>
                                        <th:block th:each="order: ${ordersList}">
                                            <option th:value="${order.orderNo}"
                                                    th:text="${order.orderNo}"></option>
                                        </th:block>
                                    </select>
                                </div>

                                <div class="form-group" style="display: none;">
                                    <input class="form-control" type="text" id="orderRef" th:field="*{orderRef}"/>
                                </div>

                                <div class="col-sm-3 form-group">
                                    <label>Customer Name</label>
                                    <input class="form-control" type="text" id="customerName" th:field="*{customerName}"
                                           placeholder="Customer Name" readonly/>

                                </div>
                                <div class="col-sm-3 form-group">
                                    <label>Mobile Number</label>
                                    <input class="form-control" type="text" id="mobileNumber" th:field="*{mobileNo}"
                                           placeholder="Mobile Number" readonly>
                                </div>
                                <div class="col-sm-3 form-group">
                                    <label>Amount (<i class="fa fa-inr"></i>)</label>
                                    <input class="form-control" type="text" id="amount" th:field="*{amount}"
                                           placeholder="Amount" readonly>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-3 form-group">
                                    <label>Product Name <span class="text-danger">*</span></label>
                                    <select class="form-control" id="productId" th:field="*{productId}">
                                        <option value="">Select</option>
                                    </select>
                                </div>
                                <div class="col-sm-3 form-group">
                                    <label>Status <span class="text-danger">*</span></label>
                                    <select class="form-control statusDropdowns" id="status" th:field="*{status}">
                                        <option value="">Select</option>
                                        <th:block th:each="notificationOrderStatus: ${notificationOrderStatus}">
                                            <option th:value="${notificationOrderStatus.status}"
                                                    th:text="${notificationOrderStatus.display}"></option>
                                        </th:block>
                                    </select>
                                </div>
                                <div class="col-sm-3 form-group reason" style="display: none;">
                                    <label>Reason <span class="text-danger">*</span></label>
                                    <input class="form-control" type="text" id="reason" th:field="*{reason}"
                                           placeholder="Reason">
                                </div>
                                <div class="col-sm-3 form-group refund" style="display: none;">
                                    <label>Refund Amount <span class="text-danger">*</span></label>
                                    <input class="form-control" type="number" id="refund" th:field="*{refund}"
                                           placeholder="Refund">
                                </div>
                                <div class="col-sm-3 form-group deliveryDate" style="display: none;">
                                    <label for="deliveryDate">Delivery Date <span class="text-danger">*</span></label>
                                    <div class="input-group date currentdatepicker">
                                        <span class="input-group-addon bg-white"><i class="fa fa-calendar"></i></span>
                                        <input class="form-control" type="text" id="deliveryDate"
                                               th:field="*{deliveryDate}" placeholder="dd/mm/yyyy" autocomplete="off">
                                    </div>
                                </div>
                                <div class="col-sm-3 form-group paymentStatus" style="display: none;">
                                    <label>Payment Status <span class="text-danger">*</span></label>
                                    <select class="form-control paymentStatusDropdowns" id="paymentStatus"
                                            th:field="*{paymentStatus}">
                                        <option value="">Select</option>
                                        <th:block th:each="notificationPaymentStatus: ${notificationPaymentStatus}">
                                            <option th:value="${notificationPaymentStatus.status}"
                                                    th:text="${notificationPaymentStatus.display}"></option>
                                        </th:block>
                                    </select>
                                </div>
                                <div class="col-sm-3 form-group">
                                    <label>Type <span class="text-danger">*</span></label>
                                    <select class="form-control" id="type" th:field="*{type}">
                                        <option value="">Select</option>
                                        <th:block th:each="notificationType: ${notificationTypes}">
                                            <option th:value="${notificationType.status}"
                                                    th:text="${notificationType.display}"></option>
                                        </th:block>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6" id="PreviewField">
                                    <div class="form-group">
                                        <label for="messagePreview">Preview</label>
                                        <textarea id="messagePreview" class="form-control" rows="4"
                                                  placeholder="Notification Preview" style="background-color:#FCF5D8;"
                                                  readonly></textarea>
                                    </div>
                                </div>
                            </div>
                            <span class="text-danger">*</span>&nbsp;&nbsp;Required fields</span>
                            <div class="form-group text-right">
                                <a class="btn btn-warning" href="/list/notification.mk"
                                   th:href="@{/list/notification.mk}">
                                    <i class="fa fa-arrow-left"></i> &nbsp; Back
                                </a>
                                <button class="btn btn-danger" type="reset">Reset</button>
                                <button id="preview" class="btn btn-primary">Preview</button>
                                <button class="btn btn-success" type="submit">Send Notification</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- END PAGE CONTENT-->
</th:block>

<th:block layout:fragment="pageplugin">
    <!-- PAGE LEVEL PLUGINS-->
    <script src="/resources/js/jquery.validate.min.js" th:src="@{/resources/js/jquery.validate.min.js}"
            type="text/javascript"></script>
    <script src="/resources/js/sweetalert2.min.js" th:src="@{/resources/js/sweetalert2.min.js}"
            type="text/javascript"></script> <!-- Sweet Alert 2 plugin -->
    <script src="/resources/js/es6-promise-auto.min.js" th:src="@{/resources/js/es6-promise-auto.min.js}"
            type="text/javascript"></script> <!-- Promise Library for SweetAlert2 working on IE -->
    <!--  Notifications Plugin    -->
    <script src="/resources/js/bootstrap-notify.js" th:src="@{/resources/js/bootstrap-notify.js}"></script>
    <script src="/resources/js/bootstrap-datepicker3.min.js"
            th:src="@{/resources/js/bootstrap-datepicker.min.js}"></script>
</th:block>

<th:block layout:fragment="pagescript">
    <!-- PAGE LEVEL SCRIPTS-->
    <script type="text/javascript" th:inline="javascript">
        /*<![CDATA[*/
            $('[rel="tooltip"]').tooltip({
                trigger: 'hover'
            });

            var orderMap = /*[[${orderMap}]]*/ '';

            $("#orderNo").change(function(){
               $("#customerName").val("");
               $("#mobileNumber").val("");
               $("#amount").val("");
               $("#orderRef").val("");
               var orderNo = $(this).val();
               var order;
               if(orderNo !== undefined && orderNo !== '' && orderNo !== null)
               {
                order = orderMap[orderNo];
                $("#customerName").val(order.user.fullName);
                $("#mobileNumber").val(order.user.mobile);
                $("#amount").val(order.orderTotal);
                $("#orderRef").val(order.orderRef);
               }

               //Fetching the product name based on order no
               $("#productId").empty();
               $("#productId").append($('<option></option>').val("").html("Select"));
               US.data_csrf['id'] = order.orderRef;
               $.get(/*[[@{/product/name.mk}]]*/ '', US.data_csrf)
                 .done(function(data) {
                   $.each(data, function(index, name){
                       $("#productId").append($('<option></option>').val(name.a).html(name.b));
                   });
                 })
                 .fail(function(data){
                    //alert("something went wrong while fetching product name");
                 });
            });

            $("#preview").click(function (e) {
            e.preventDefault();
                if($('#notificationForm').valid()){
                    var form = $('#notificationForm')[0];
                    var data = new FormData(form);
                    $.ajax({
                        type: "POST",
                        enctype: 'multipart/form-data',
                        url: "/message/preview.mk",
                        data: data,
                        processData: false,
                        contentType: false,
                        cache: false,
                        timeout: 600000,
                        success: function (data) {
                              $("#messagePreview").val(data.preview);
                        },
                        error: function (e) {
                            $('#cover-spin').hide();
                            // write error here...
                        }
                    });
                }
            });

            $(".statusDropdowns").change(function(){
                if ($('#status').val() == 'C') {
                    $('.reason').show();
                    $('.refund').hide();
                    $('.deliveryDate').hide();
                    $('.paymentStatus').hide();
                    $('#refund').val("");
                    $('#deliveryDate').val("");
                    $('#paymentStatus').val("");
                }
                else if ($('#status').val() == 'R'){
                    $('.refund').show();
                    $('.reason').hide();
                    $('.deliveryDate').hide();
                    $('.paymentStatus').hide();
                    $('#reason').val("");
                    $('#deliveryDate').val("");
                    $('#paymentStatus').val("");
                }
                else if ($('#status').val() == 'S'){
                    $('.deliveryDate').show();
                    $('.reason').hide();
                    $('.refund').hide();
                    $('.paymentStatus').hide();
                    $('#reason').val("");
                    $('#refund').val("");
                    $('#paymentStatus').val("");
                }
                else if ($('#status').val() == 'N'){
                    $('.paymentStatus').show();
                    $('.reason').hide();
                    $('.refund').hide();
                    $('.deliveryDate').hide();
                    $('#refund').val("");
                    $('#refund').val("");
                    $('#deliveryDate').val("");
                }

                else {
                    $('.reason').hide();
                    $('.refund').hide();
                    $('.deliveryDate').hide();
                    $('.paymentStatus').hide();
                    $('#refund').val("");
                    $('#refund').val("");
                    $('#deliveryDate').val("");
                    $('#paymentStatus').val("");
                }
            });

            //JQuery Validator
            $('#notificationForm').validate({
                rules: {
                    orderNo: {
                        required: true
                    },
                    productId: {
                        required: function(){
                      if ($('#status').val() == 'N'){
                      return false;
                      }
                      else {
                      return true;
                      }}
                    },
                    type: {
                        required: true
                    },
                    status:{
                         required: true
                    },
                    reason:{
                         required: true,
                         maxlength: 30
                    },
                    refund:{
                         required: true
                    },
                    deliveryDate:{
                         required: true
                    },
                    paymentStatus:{
                        required:true
                        }
                },
                messages: {
                    orderNo: {
                        required: "Please select Order No"
                    },
                    productId: {
                        required: "Please select Product Name"
                    },
                    type: {
                        required: "Please select message type"
                    },
                    status: {
                        required: "Please select order status"
                    },
                    reason: {
                        required: "Please enter reason",
                        maxlength: "Please enter not more than 30 characters"
                    },
                    refund: {
                        required: "Please enter refund amount"
                    },
                    deliveryDate: {
                        required: "Please enter date"
                    },
                    paymentStatus: {
                        required: "Please Select payment status"
                    }

                },
                errorClass: "help-block error",
                highlight: function (e) {
                    $(e).closest("#NewUnitForm .form-group").addClass("has-error")
                },
                unhighlight: function (e) {
                    $(e).closest("#NewUnitForm .form-group").removeClass("has-error")
                }
            }); // end of validator

            $('.currentdatepicker').datepicker({
                    todayBtn: true,
                    keyboardNavigation: false,
                    forceParse: false,
                    calendarWeeks: true,
                    autoclose: true,
                    format: "dd/mm/yyyy"
                });

            <!--var orderNo = /*[[${orderNo}]]*/ '';-->
            <!--console.log(orderNo)-->
        	<!--if(orderNo !== undefined && orderNo !== '' && orderNo !== null){-->
        	    <!--var message = 'Message sent to Order - <b>'+ orderNo +'</b> Successfully.';-->
        	    <!--$.notify({-->
                    <!--icon: 'fa fa-bell-o rel',-->
                    <!--message: message-->
                    <!--},{-->
                    <!--type: 'success',-->
                    <!--timer: 2000,-->
                    <!--placement: {-->
                        <!--from: 'top',-->
                        <!--align: 'center'-->
                    <!--}-->
                <!--});-->
            <!--}-->

            /*]]>*/




    </script>
</th:block>

</body>
</html>